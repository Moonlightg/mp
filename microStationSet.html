<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=3, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>制作微站</title>
    <script src="js/jquery-3.2.1.min.js"></script>
    <script src="js/common.js"></script>
    <link rel="stylesheet" href="css/app-base.css">
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://cdn.bootcss.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://cdn.bootcss.com/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body>
    <div id="app" class="mp-main">
      <input type="hidden" id="insertType" value="0">
      <section class="mp-container auto flex-box">
        <div class="micro-head">
          <!-- 浏览、收藏人数统计 -->
          <div class="micro-statistics">
            <p><i class="icon-fwsl"></i><span>24841</span></p>
            <p><i class="icon-wzsc"></i><span>24841</span></p>
          </div>
          <!-- 背景音乐播放 微站编辑-->
          <div class="micro-btn-box">
            <div class="micro-btn-item mp-audio">
              <img src="images/yy.png">
            </div>
            <div class="micro-btn-item">
              <img src="images/bjwz.png">
            </div>
          </div>
          <div class="visiting-card">
            <div class="visiting-card_user">
              <a href="javascript:;">
                <div class="visiting-card_user_img">
                  <img src="images/user2.png" alt="一个小灰猫">
                </div>
                <h3>李大伟</h3>
                <p>执行董事长</p>
                <p>人生若只如初见，何事秋风悲画扇，等闲变却故人心</p>
              </a>
            </div>
            <div class="micro-head_btn flex">
              <a href="tel:13112224413"><i class="icon-tel-a2"></i><span>联系我</span></a>
              <a href="javascript:;" class="open-modal"><i class="icon-wx-a2"></i><span>加好友</span> </a>
            </div>
          </div>
          <!-- 微链接 -->
          <div class="folder-link flex" style="display: none;">
            <div class="folder-item brick">
              <div class="folder-icon link-icon">
                <i class="icon-link"></i>
                <i class="icon-close"></i>
              </div>
              <div class="folder-name">我的微链接</div>
            </div>
            <div class="folder-item brick">
              <div class="folder-icon link-icon">
                <i class="icon-link"></i>
                <i class="icon-close"></i>
              </div>
              <div class="folder-name">我的微链接</div>
            </div>
            <div class="folder-item brick">
              <div class="folder-icon link-icon">
                <i class="icon-link"></i>
                <i class="icon-close"></i>
              </div>
              <div class="folder-name">我的微链接</div>
            </div>
            <div class="folder-item brick">
              <div class="folder-icon link-icon">
                <i class="icon-link"></i>
                <i class="icon-close"></i>
              </div>
              <div class="folder-name">我的微链接</div>
            </div>
            <div class="folder-item brick">
              <div class="folder-icon link-icon">
                <i class="icon-link"></i>
                <i class="icon-close"></i>
              </div>
              <div class="folder-name">我的微链接</div>
            </div>
            <div class="folder-item brick">
              <div class="folder-icon link-icon">
                <i class="icon-link"></i>
                <i class="icon-close"></i>
              </div>
              <div class="folder-name">我的微链接</div>
            </div>
          </div>
        </div>
        <div class="micro-center article-details page-a" style="background: #fff;color: #333;">
          <!-- 制作微站 开始 -->
          <div class="ms-add-btn minpage-empty-box" data-action="empty-addColumn">
            <i class="icon-add"></i>
          </div>
          <div id="miniDetail">
          </div>
        </div>
      </section> 
      <section class="minpage-popup-masks" id="popUp-insertType">
        <div class="popitembox flexbox-container">
          <div class="fixed">
            <div class="closebtn">
              <i class="icon-arrow-left"></i>
            </div>
            <div class="scrollbox">
              <ul class="scrollbox-ul fixed">
                <li data-action="1" class="">
                  <i class="icon-wz-set mp-color1" title="文本"></i>
                  <span>文字</span>
                  <input type="checkbox">
                </li>
                <li data-action="2" class="">
                  <i class="icon-wz-set mp-color2" title="图片"></i>
                  <span>图片</span>
                  <input type="checkbox">
                </li>
                <li data-action="4" class="">
                  <i class="icon-wz-set mp-color3" title="链接"></i>
                  <span>链接</span>
                  <input type="checkbox">
                </li>
                <li data-action="3" class="">
                  <i class="icon-wz-set mp-color4" title="视频"></i>
                  <span>视频</span>
                  <input type="checkbox">
                </li>
                <li data-action="6" class="">
                  <i class="icon-wz-set mp-color5" title="地图"></i>
                  <span>地图</span>
                  <input type="checkbox">
                </li>
                <li data-action="music" class="">
                  <i class="icon-wz-set mp-color6" title="音乐"></i>
                  <span>音乐</span>
                  <input type="checkbox">
                </li>
              </ul>
            </div>
            <div class="insert-item-btn mp-btn mp-btn-blue">插入内容</div>
          </div>
        </div>
      </section>
    </div>
    <script>
      $(function(){
        // 第一次添加组件的内容 
        $('.page-a').on('click','[data-action="empty-addColumn"]',function(){
          console.log(222);
          $('#insertType').val('0');
          initMethod.showPopChooseType();
          return false;
        });
        // 隐藏--添加组件弹出框 
        $('.mp-main').on('click','.minpage-popup-masks .closebtn',function(){
          initMethod.hidePopChooseType();
          return false;
        });
        // 添加组件--选择类型
        $('.scrollbox-ul li').on('click',function(){
          if ($(this).hasClass('checked')) {
            $(this).removeClass('checked');
          } else {
            $(this).addClass('checked');
          }
          return false;
        });
        // 添加组件--插入内容 
        $('#popUp-insertType').on('click','.insert-item-btn',function(){
          initMethod.comfirmInsertItem();
        });
         // 插入组件内容 
        $('.page-a').on('click','.addtool-btn',function(){
            // 设置标识为1，表示不是首次添加组件
            $('#insertType').val('1');
            // 判断点击的是组件上面按钮还是下面的按钮
            if($(this).hasClass('nextAddbtn')){
                compentInsertType = 1;
            }else{
                compentInsertType = -1;
            }
            initMethod.showPopChooseType();
            return false;
        });
        // 点击组件显示上移／下移／移出 弹出框 
        $('.page-a').on('click','.show-compent',function(){
            compentClickFg = 1;
            var obj = $(this);
            var deleteFg = obj.find('.statafg').attr('data-delete');
            if(!obj.hasClass('cur')){
                initMethod.showBtOperatebox(obj,deleteFg);
            }
            setTimeout(function(){
                var curAssemblyTop = $('.page-a').scrollTop();
                if(obj.offset().top < 50 ){
                    console.log('上滚顶条');
                    var curScrollTop = curAssemblyTop+obj.offset().top > 280 ? curAssemblyTop+obj.offset().top-90 :curAssemblyTop+obj.offset().top-66;
                    $('.page-a').scrollTop(curScrollTop); /*滚动条的位置上移超出头部的距离*/
                }else if(obj.offset().top + obj.height() > $('.mp-container').height()-95){
                    $('.page-a').scrollTop(curAssemblyTop+obj.offset().top-120); /*滚动条的位置上移超出头部的距离*/
                }
            },1)
        });
        // 点击跳转编辑
        $('.page-a').on('click','#miniDetail .popReplacebox',function(){
            var obj = $(this).parent();
            var editFg =  obj.find('.statafg').attr('data-edit');
            //var url = obj.attr('data-url');
            //operateRemoteData.jumpTopage(url,editFg);
            noticeTis("老板，编辑还没搞明白怎么做");
        });
        // 滚动条滚动消失组件编辑栏
        $('.page-a').on('scroll',function(){
            if( curHandle != 1 && compentClickFg != 1){
                initMethod.hideBtOperatebox();
            }
            curHandle = 0;
            compentClickFg = 0;
            compentInsertType = 0;
            return false;
        });
        // 点击组件删除
        $('#miniDetail').on('click','.show-compent.cur .btfix-Pop-operate .closeboxbtn ',function(){
            var obj = $(this).parent().parent();
            confirm("确定要删除该组件？",initMethod.deleteCompent,obj);
            return false;
        });
        // 点击组件上移
        $('#miniDetail').on('click','.show-compent.cur .btfix-Pop-operate .moveUp',function(){
            var obj = $(this).parent().parent().parent();
            initMethod.assemblyMoveup(obj);
            curHandle = 1;
            return false;
        });
        // 点击组件下移
        $('#miniDetail').on('click','.show-compent.cur .btfix-Pop-operate .moveDown',function(){
            var obj = $(this).parent().parent().parent();
            initMethod.assemblyMoveDown(obj);
            curHandle = 1;
            return false;
        });
      });


      // 此处开始初始化
      var curHandle = 0; // 操作代码
      var compentClickFg = 0; // 是否处于点击状态
      var compentInsertType = 0; // 1:表示插入组件背后 -1:表示插入在组件之前
      var initMethod={
        // 展示组件底部编辑栏
        showBtOperatebox:function(obj,deleteFg){ 
            obj.siblings('.show-compent').find('.btfix-Pop-operate,.popReplacebox').remove();
            $('.addtool-btn').remove();
            obj.siblings('.show-compent').removeClass('cur');
            var operateHtml ='';
            operateHtml +='<div class="btfix-Pop-operate">';
            if(deleteFg != 1){
                operateHtml += '<span class="closeboxbtn fl"><i class="icon-minpage icon-close"></i></span>';
            }
            operateHtml += '<span class="fr">';
            operateHtml += '<em class="moveUp">上移</em>';
            operateHtml += '<em class="moveDown">下移</em>';
            operateHtml += '</span>';
            operateHtml += '</div>';
            if(deleteFg == 1){
                operateHtml += '<div class="popReplacebox turnbox flex-center">';
            }else{
                operateHtml += '<div class="popReplacebox flex-center">';
            }
            operateHtml += '<div>';
            if(obj.hasClass('reprint')){
                operateHtml += '<p>转载内容无法编辑</p><p>(过长的组件内容已自动收缩)</p>';
            }else{
                operateHtml += '<p>编辑</p>';
            }
            operateHtml += '</div>';
            operateHtml += '</div>';
            var addToolPreBtn =''
                +'<div class="addtool-btn preAddbtn">'
                +   '<i class="icon-minpage icon-add"></i>'
                +'</div>';
            var addToolNextBtn = ''
                +'<div class="addtool-btn nextAddbtn">'
                +   '<i class="icon-minpage icon-add"></i>'
                +'</div>';

            if(obj.find('.btEditfixBox').length == 0){
                if(deleteFg == 1){
                    obj.addClass('turn cur');
                }else{
                    obj.addClass('cur');
                }
                obj.append(operateHtml);
                $(addToolNextBtn).insertAfter(obj);
                $(addToolPreBtn).insertBefore(obj);
                curAssemblyScroll = $('.show-compent').offset().top;
            }
        },
        //显示--选择插入类型
        showPopChooseType:function(){ 
          $('#popUp-insertType').addClass('active');
        },
        //隐藏--选择插入类型
        hidePopChooseType:function(){ 
          $('.minpage-popup-masks').removeClass('active');
          $('.scrollbox-ul.fixed li').removeClass('checked');
        },
        comfirmInsertItem:function(){
          var comps = $('#popUp-insertType .scrollbox-ul').find('.checked');
          var pdid="";//各个控件的id
          var music="";//标记，是否要添加music
          //收集所有要提交 组件的ID
          for(var c=0; c < $(comps).length;c++) {
              if($(comps[c]).attr('data-action')=="music") {
                  music = "music";
                  continue;
              }
              pdid += $(comps[c]).attr('data-action')+",";
          }
          //删除最后一个无效的 逗号
          pdid = pdid.substring(0, pdid.lastIndexOf(","));
          var insertTypeVal = compentInsertType == 1? 1:-1;
          var obj;
          if($('.show-compent.cur').length == 0){
            if($('#insertType').val() == 0 ){
              obj =  $('#miniDetail');
            }else if($('#insertType').val() == 2 ){
              obj =  $('#miniDetail').find('.show-compent').last();
            }
          }else{
            obj = $('.show-compent.cur');
          }
          noticeTis("插入成功");
          var emptyFg = $('#miniDetail .show-compent').length == 0 ? 1:-1;
          initMethod.addModule(pdid,music);
          initMethod.hidePopChooseType();
          if(emptyFg == 1){
            initMethod.judgeGuideOperate();
          }
          if($('#insertType').val() == 2 ){
            var pageHg = $('.con').height()+200;
            $('.page-a').scrollTop(pageHg);
          }
          var nextBtn = '<div class="addtool-btn nextAddbtn"><i class="icon-minpage icon-add"></i></div>';
          $('.addtool-btn.nextAddbtn').remove();
          $(nextBtn).insertAfter($('.show-compent.cur'));
          //operateRemoteData.ajaxInsertModule(obj, pdid,music,insertTypeVal,success, error);
        },
        //构建未编辑的情况
        miniPageModuleBulid:function(text,id){
            var html = "<div class='edit-show edit-show-border show-compent'" +
                "id=\""+id+"\"" +
                "data=\""+id+"\">";
            html += "<div class=\"edit-addtool\"><div class=\"txt\"><a class=\"txt-href\">";
            html += "点击编辑" + text;
            if(text == '文字'){
                html += '<i class="icon-wz-set mp-color1"></i>';
            }else if(text == '图片'){
                html += '<i class="icon-wz-set mp-color2"></i>';
            }else if(text == '链接'){
                html += '<i class="icon-wz-set mp-color3"></i>';
            }else if(text == '视频'){
                html += '<i class="icon-wz-set mp-color4"></i>';
            }else if(text == '地图'){
                html += '<i class="icon-wz-set mp-color5"></i>';
            }
            html += "</div></div></div>";
            // 判断是否是第一次添加，第一次添加成功后隐藏大按钮
            if($('#insertType').val() == 1 ){
                if(compentInsertType == 1){
                    $(html).insertBefore($('.addtool-btn.nextAddbtn'));
                }else{
                    $(html).insertBefore($('.addtool-btn.preAddbtn'));
                }
            }else{
                $('#miniDetail').append(html);
                $('.minpage-empty-box').hide();
            }
        },
        // 添加组件
        addModule: function (pdid, music) {
            var idsId = parseInt(Math.random() * 1000);
            var str = pdid.split(",");
            if (pdid.length != 0) {
                for (var i = 0; i < str.length; i++) {
                    pdid = str[i];
                    if (pdid == 1) {
                        initMethod.miniPageModuleBulid('文字','text'+idsId);
                    } else if (pdid == 2) {
                        initMethod.miniPageModuleBulid('图片','img'+idsId);
                    } else if (pdid == 3) {
                        initMethod.miniPageModuleBulid('视频','video'+idsId);
                    } else if (pdid == 4) {
                        initMethod.miniPageModuleBulid('链接','link'+idsId);
                    } else if (pdid == 6) {
                        initMethod.miniPageModuleBulid( '地图','dt'+idsId);
                    }
                }
            }
            //关闭界面后才显示
            if (music == "music") {
                initMethod.addMusic();
            }

        },
        // 点击组件显示操作按钮
        judgeGuideOperate:function () { 
            $('#miniDetail .show-compent').eq(0).trigger('click');
        },
        // 删除组件
        deleteCompent:function(obj){
            noticeTis("删除成功");
            obj.remove();
            $('.addtool-btn').remove();
            if($("#miniDetail>div").length==0){
              $('.ms-add-btn').show();
            }
        },
        addMusic: function () {
            location.href = 'Music.html';
        },
        // 组件上移
        assemblyMoveup:function(obj){ 
            var curIndex = obj.index();
            var type ="上移";
            var data =[];
            data.type= type;
            data.obj = obj;
            console.log("当前序号"+ curIndex);
            if(curIndex == 1){
                noticeTis("当前为第一个组件，不可上移哦！");
                return;
            }else{
                var curAssemblyTop = $('.page-a').scrollTop();
                var nextAssemblyHg = $('.show-compent.cur').prev().prev('.show-compent').height() +15;
                var curNodeHtml = $('.addtool-btn.preAddbtn')[0].outerHTML+obj[0].outerHTML + $('.addtool-btn.nextAddbtn')[0].outerHTML; //当前节点
                $('.addtool-btn').remove();
                $(curNodeHtml).insertBefore(obj.prev('.show-compent'));
                obj.remove();
                $('.page-a').scrollTop(curAssemblyTop-nextAssemblyHg);
            }
        },
        // 组件下移
        assemblyMoveDown:function(obj){ 
            var curIndex = obj.index();
            var assembly = $('.show-compent').length;
            var type ="下移";
            var data =[];
            data.type= type;
            data.obj = obj;
            if( curIndex == assembly){
                noticeTis("当前为最后一个组件，不可下移哦！")
            }else{
                var curAssemblyTop = $('.page-a').scrollTop();
                if( $('.show-compent.cur').next('.addtool-btn').length == 0){
                    var prevAssemblyHg = $('.show-compent.cur').next('.show-compent').offset().height + 15;
                }else{
                    var prevAssemblyHg = $('.show-compent.cur').next().next('.show-compent').offset().height+15;
                }
                var curNodeHtml = $('.addtool-btn.preAddbtn')[0].outerHTML+obj[0].outerHTML + $('.addtool-btn.nextAddbtn')[0].outerHTML; //当前节点
                $('.addtool-btn').remove();
                $(curNodeHtml).insertAfter(obj.next('.show-compent'));
                obj.remove();
                $('.page-a').scrollTop(curAssemblyTop+prevAssemblyHg);
            }
        }
      }
    </script>
  </body>
</html>
